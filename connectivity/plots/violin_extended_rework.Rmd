---
title: "Untitled"
author: "Victor MÃ¸ller"
date: "20 maj 2019"
output: html_document
---

updated 09-11-2019.
Still much work to do. 

```{r}

library(pacman)
p_load(readr, tidyverse, ggplot2, RColorBrewer, reshape2, ggthemes,
       viridis, ggridges, ggunchained, rlang)

```

loading data. 

```{r}

#working directory. 
setwd("~/CRUST-1/data/tests")
path = "~/CRUST-1/data/tests/"
files <- list.files(path = path, pattern="*csv")

#taken from the scatter-plot file (reconsider what is needed)
mycols <- c("replica", 
            "turn", 
            "studies", 
            "network", 
            "population", 
            "sigma",
            "base_SS",
            "colab_cond",
            "net_size",
            "true_model",
            "strategy",
            "switch_rep_study",
            "switch_rep",
            "prop_true",
            "prop_t_mod")

#loading them 
dfList <- lapply(files, function(f) {  
   read.csv(paste0(path, f))[mycols]
})

#subsetting (because of computational demands)
df <- do.call(rbind, dfList) 
rm(dfList)

```

Preprocessing (should also be adjusted to accommodate better early prep). 

```{r}

df <- df %>%
  mutate(true_model = factor(true_model),
         base_SS = factor(base_SS),
         sigma = factor(sigma))

#replication rate small world 
df_RR <- df %>%
  group_by(replica, network, population, sigma, true_model,
           base_SS, net_size, colab_cond) %>%
  summarize(RR = sum(switch_rep) / 
              sum(switch_rep_study)) 

```


raincloud prep

```{r}

#preparing raincloud (can be customized)
raincloud_theme = theme(
text = element_text(size = 10),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
axis.text = element_text(size = 14),
axis.text.x = element_text(vjust = 0.5),
legend.title=element_text(size=16),
legend.text=element_text(size=16),
legend.position = "right",
plot.title = element_text(lineheight=.8, face="bold", size = 16),
panel.border = element_blank(),
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'))

```

new directory & loading flatViolin

```{r}
setwd("~/CRUST-1")
baseDir <- "."
scriptDir <- paste0(baseDir, "/src/functions")
inputDir <- paste0(baseDir, "/data")
outputDir <- paste0(baseDir, "/data")
source(paste0(scriptDir, "/flatViolin.R"))
```

Raincloud plot.
By inputting total_RR_sig instead we get a plot grouped by sigma & 
thus with 3 times the number of observations. 

```{r}

#raincloud plot

RR_FUN <- function(df, var){
  
  var <- enquo(var)

g <- df %>%
  filter(base_SS == "20") %>%
  ggplot(aes(x = UQ(var), 
             y = RR, fill = UQ(var))) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
  geom_point(aes(y = RR, color = UQ(var)), 
                  position = position_jitter(width = .15), 
                  size = .5, alpha = 0.8) +
  geom_boxplot(width = .1, outlier.shape = NA, alpha = 0.5) +
  expand_limits(x = 3) +
  guides(fill = FALSE) + 
  guides(color = FALSE) +
  scale_fill_tableau() +
  scale_color_tableau() +
  #coord_flip() +
  theme_bw() +
  labs(title = "Replication rate for populations",
       subtitle = "Sample size: 100",
       x = "Population", 
       y = "Replication rate") + #sets the legend title.
  raincloud_theme

#call the plot
g

}

#running the function 
colnames(df_RR)
RR_FUN(df_RR, population)
RR_FUN(df_RR, sigma)
RR_FUN(df_RR, network)
RR_FUN(df_RR, true_model)
RR_FUN(df_RR, colab_cond)

```

trying to group by true model. 

```{r}

MOD_FUN <- function(.df, .var1, .var2){
  
  var1 <- enquo(.var1)
  var2 <- enquo(.var2)
  print(var1)
  print(var2)
  
#raincloud plot
  g <- .df %>%
    ggplot(aes(x = UQ(var1), y = RR, fill = UQ(var2))) +
    geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .7) +
    geom_point(aes(y = RR, color = UQ(var2)), 
                    position = position_jitter(width = .15), 
                    size = .5, alpha = 0.8) +
    geom_boxplot(width = .1, outlier.shape = NA, alpha = 0.5) +
    expand_limits(x = 2) + #not clear that this changes much. 
    #guides(fill = FALSE) + #legend can be deleted. 
    guides(color = FALSE) +
    scale_fill_tableau() +
    scale_color_tableau() +
    #coord_flip() +
    theme_bw() +
    labs(title = "Replication rate for populations",
         subtitle = "Grouped by true model", 
         x = "Population", 
         y = "Replication rate",
         fill = "True model") + #sets the legend title.
    raincloud_theme
  
  #call the plot
  g

}

colnames(df_RR)
MOD_FUN(df_RR, population, true_model)
MOD_FUN(df_RR, population, sigma)
MOD_FUN(df_RR, sigma, true_model)

```

with RR for true model (preprocessing)
by global

```{r}
#creating the grouped by (3 rows missing)
by_global <- small %>%
  group_by(final_global_true_model, replica, network, population, 
           true_model, sigma, sample_size) %>%
  summarize(RR = sum(edges_replicated) / sum(edges_replication_study)) %>%
  filter(final_global_true_model == 1) 

#adding stuff.  
small_RR <- small_RR %>%
  mutate(final_global_true_model = "Overall") 

#changing stuff
by_global$final_global_true_model <- "True"

#cbinding 
all_overall <- rbind(by_global, small_RR)

#factor. 
all_overall$final_global_true_model <- as.factor(all_overall$final_global_true_model)
```


```{r}

#raincloud plot
g <- all_overall %>%
  filter(sample_size == "100") %>%
  ggplot(aes(x = population, 
                              y = RR, fill = final_global_true_model)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .7) +
  geom_point(aes(y = RR, color = final_global_true_model), 
                  position = position_jitter(width = .15), 
                  size = .5, alpha = 0.8) +
  geom_boxplot(width = .1, outlier.shape = NA, alpha = 0.5) +
  expand_limits(x = 2) + #not clear that this changes much. 
  #guides(fill = FALSE) + #legend can be deleted. 
  guides(color = FALSE) +
  scale_fill_tableau() +
  scale_color_tableau() +
  #coord_flip() +
  theme_bw() +
  labs(title = "Replication rate for populations",
       subtitle = "Grouped by true model", 
       x = "Population", 
       y = "Replication rate",
       fill = "Replication rate") + #sets the legend title.
  raincloud_theme

#call the plot
g
```

sigma 100 

```{r}

#sigma as factor
small_RR$sigma <- as.factor(small_RR$sigma)

#raincloud plot
g <- small_RR %>%
  filter(sample_size == "100") %>%
  ggplot(aes(x = population, 
                              y = RR, fill = sigma)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .7) +
  geom_point(aes(y = RR, color = sigma), 
                  position = position_jitter(width = .15), 
                  size = .5, alpha = 0.8) +
  geom_boxplot(width = .1, outlier.shape = NA, alpha = 0.5) +
  expand_limits(x = 2) + #not clear that this changes much. 
  #guides(fill = FALSE) + #legend can be deleted. 
  guides(color = FALSE) +
  scale_fill_tableau() +
  scale_color_tableau() +
  #coord_flip() +
  theme_bw() +
  labs(title = "Replication rate by population",
       subtitle = "Sample size: 100", 
       x = "Population", 
       y = "Replication rate",
       fill = "Sigma") + #sets the legend title.
  raincloud_theme

#call the plot
g

```

for sample size 20

```{r}

#raincloud plot
g1 <- small_RR %>%
  filter(sample_size == "20") %>%
  ggplot(aes(x = population, 
                              y = RR, fill = sigma)) +
  geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .7) +
  geom_point(aes(y = RR, color = sigma), 
                  position = position_jitter(width = .15), 
                  size = .5, alpha = 0.8) +
  geom_boxplot(width = .1, outlier.shape = NA, alpha = 0.5) +
  expand_limits(x = 2) + #not clear that this changes much. 
  #guides(fill = FALSE) + #legend can be deleted. 
  guides(color = FALSE) +
  scale_fill_tableau() +
  scale_color_tableau() +
  #coord_flip() +
  theme_bw() +
  labs(title = "Replication rate by population",
       subtitle = "Sample size: 20", 
       x = "Population", 
       y = "Replication rate",
       fill = "Sigma") + #sets the legend title.
  raincloud_theme

#call the plot
g1

library(cowplot)
plot_grid(g, g1)

```

