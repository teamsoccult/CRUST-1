---
title: "Untitled"
author: "Victor MÃ¸ller"
date: "25 maj 2019"
output: html_document
---

14-09-2019
This document tests & cleans data from ABM5. 
It is probably only going to work for test-phase with small
amounts of data. It takes data from "new_data" folder and outputs to "tests".

```{r}
#set working directory to where you have raw files
setwd("~/CRUST-1/data/new_data")

#packages
library(pacman)
p_load(tidyverse, tidyselect)

```

Loading data

```{r}

#file-names
temp <- list.files(pattern="*csv")

#loading them 
for(i in 1:length(temp)) assign(temp[i], read.csv(temp[i], sep = ";"))

#bind all together - coerces something into character. 
data <- mget(ls(pattern="*csv")) %>%
              bind_rows()

#remove all the old shit 
rm(list=setdiff(ls(), "data")) 

#remove NA: 
data <- na.omit(data) 


```

Naive tests in sequential order. 
Just testing whether we have the right data. 


```{r}

#factorizing 
data <- data %>%
  mutate(network = as.factor(network),
         population = as.factor(population),
         colab_cond = as.factor(colab_cond),
         strategy = as.factor(strategy))

#summary tests
summary(data$turn) #max should be whatever max is set to (check ABM2 for input)
summary(data$network) #Lattice, Small 
summary(data$population) #All, Bo, Mave, Tess
summary(data$sigma) #min: 0.2, mean: 0.5, max: 0.8
summary(data$base_SS) #min: 20, mean: 60, max: 100
summary(data$true_model) #min: 2, mean: 7.33!!, max: 13. 
summary(data$strategy) #VERY SKEWED!

```

More sophisticated tests. 
Comments reflect expected output (if code is working as it should).

```{r}

#check 0: all stud. max should be what you set stud. max to. 
summary(data$studies) 

check <- data %>%
  group_by(colab_cond, replica, network, base_SS, population) %>%
  summarize(stud = max(studies))

#check 1: true model = the true model 
data2 <- data %>%
  filter(true_model == 2)

data7 <- data %>%
  filter(true_model == 7)

data13 <- data %>%
  filter(true_model == 13)

all(data2$proportion_2 == data2$proportion_true) #TRUE
all(data7$proportion_7 == data7$proportion_true) #TRUE
all(data13$proportion_13 == data13$proportion_true) #TRUE

#remove
rm(list=setdiff(ls(), "data")) 

#check 2: sum of proportions
sum(data[32:45]) #same as number of rows. 

#check 3: more than or equal to should test than change
all(data$switch_testing >= data$switch_changing) #TRUE 
all(data$switch_all >= data$switch_testing) #TRUE

#check 4: replication and not replication = all replication. 
data_check <- data %>%
  mutate(rep_stud = switch_rep + switch_not_rep)

all(data_check$switch_rep_study == data_check$rep_stud) #TRUE 

#check 5: true changing and true rejecting = all true. 
data_check <- data %>%
  mutate(all_true = switch_true_changing + switch_true_rejecting)
  
all(data_check$all_true == data_check$switch_true) #TRUE 

#remove
rm(list=setdiff(ls(), "data")) 

#check 5.1: switch_all = switch_global + switch_not_global 
data_check <- data %>%
  mutate(all = switch_global + switch_not_global)

all(data_check$all == data_check$switch_all)

#check 6: only colab in colab & more research than neighbor. 
colab <- data %>%
  group_by(colab_cond, strategy) %>%
  summarize(count = n())

#check 7: all above 10,000 studies (but not too much). 
colab <- data %>%
  group_by(colab_cond, network) %>%
  summarize(study_max = max(studies))

rm(list=setdiff(ls(), "data")) 

#check 8: checking SS spread in colab condition
ss_spread <- data %>%
  filter(colab_cond == "yes") %>%
  group_by(network) %>%
  summarize(SS_max = max(SS), #TOM & PT > SMALL > LATTICE
            SS_mean = mean(SS), #all between 100-120 (ish). 
            SS_median = median(SS)) #always 100

rm(list=setdiff(ls(), "data")) 

#check 9: should be something in all variations. 
no_lab <- data %>%
  group_by(network, population, sigma, net_size, base_SS, true_model,
           colab_cond) %>%
  summarize(testing = sum(switch_testing),
            changing = sum(switch_changing),
            true = sum(switch_true),
            true_changing = sum(switch_true_changing),
            true_rejectiing = sum(switch_true_rejecting),
            rep_stud = sum(switch_rep_study),
            rep = sum(switch_rep),
            no_rep = sum(switch_not_rep))

```

Filtering columns

```{r}

#selecting the columns we don't want. 
#cols <- c("") any cols we don't want. 

#data <- data %>%
  #dplyr::select(-one_of(cols)) 

#BE CAREFUL, YOU ARE DELETING DATA!!
#data <- data %>%
  #subset(studies <= 11000)

#checking whether it worked
data_check <- data %>%
  group_by(replica, sigma, population) %>%
  summarize(studymax = max(studies))
  
#changing column index (hacky but works)


```

new working directory & writing files.

```{r}

#output directory - NOW TESTS.
setwd("~/CRUST-1/data/tests")

getwd()
write.csv(data, "victorBash.csv", row.names = FALSE)

```


